(()=>{"use strict";(()=>{const e=["button","input","select","textarea","[tabindex]"];window.util={clearElement:(e,t)=>{const o=e.children;for(let n=o.length-1;n>=0;n--){let r=!0;if(t)for(let e=0;e<t.length;e++)if(o[n].matches(t[e])){r=!1;break}r&&e.removeChild(o[n])}},toggleFormDisability:(t,o)=>{let n=[];e.forEach((e=>{n=n.concat(Array.from(t.querySelectorAll(`${e}`)))})),o?n.forEach((e=>{e.setAttribute("disabled","")})):n.forEach((e=>{e.removeAttribute("disabled")}))},isEnterEvent:(e,t)=>{"Enter"===e.key&&(e.preventDefault(),t(e))},isEscEvent:(e,t)=>{"Escape"===e.key&&(e.preventDefault(),t())},fitToRange:(e,t,o)=>{let n;return n=e<t?t:e>o?o:e,n},debounce:(e,t)=>{let o=null;return(...n)=>{o&&window.clearTimeout(o),o=window.setTimeout((()=>{e(...n)}),t)}},getNoun:(e,t,o,n,r)=>{let i=Math.abs(e);return i%=100,i>=5&&i<=20?r:(i%=10,1===i?o:i>=2&&i<=4?n:0===i?t:r)}}})(),window.load=(e,t,o,n,r,i)=>{const a=new XMLHttpRequest;a.responseType="json",a.timeout=r,a.addEventListener("load",(()=>{200===a.status?o(a.response):n(`Статус ответа: ${a.status} ${a.statusText}`)})),a.addEventListener("error",(()=>{n("Произошла ошибка соединения")})),a.addEventListener("timeout",(()=>{n(`Запрос не успел выполниться за ${a.timeout} мс`)})),a.open(t,e),i?a.send(i):a.send()},(()=>{const e=document.querySelector(".map"),t=document.querySelector("#address"),o=document.querySelector(".map__pins"),n=o.querySelector(".map__pin--main"),r=(o,n)=>{const r=o+32.5,i=e.classList.contains("map--faded")?n+65:n+81;t.setAttribute("value",`${Math.round(r)}, ${Math.round(i)}`)},i=(e,t,o,i)=>{let a=window.util.fitToRange(e-o,-32.5,1167.5),s=window.util.fitToRange(t-i,49,549);n.style.left=`${a}px`,n.style.top=`${s}px`,r(a,s)};window.pin={onMainPinMouseDown:e=>{let t=!1;const r=o.getBoundingClientRect(),a=n.getBoundingClientRect(),s=e.clientX-a.left,c=e.clientY-a.top,d=e=>{t=!0;const o=e.clientX-r.left,n=e.clientY-r.top;i(o,n,s,c)},l=()=>{if(!t){const t=e.clientX-r.left,o=e.clientY-r.top;i(t,o,s,c)}document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",l)},onMainPinKeydown:e=>{const t=o.getBoundingClientRect(),r=n.getBoundingClientRect(),a=r.left-t.left,s=r.top-t.top;switch(e.key){case"ArrowLeft":e.preventDefault(),i(a-10,s,0,0);break;case"ArrowRight":e.preventDefault(),i(a+10,s,0,0);break;case"ArrowUp":e.preventDefault(),i(a,s-10,0,0);break;case"ArrowDown":e.preventDefault(),i(a,s+10,0,0)}},changeAddress:r}})(),(()=>{const e={palace:{name:"Дворец",minPrice:1e4},flat:{name:"Квартира",minPrice:1e3},house:{name:"Дом",minPrice:5e3},bungalow:{name:"Бунгало",minPrice:0}},t=document.querySelector("#card").content.querySelector(".map__card"),o=document.querySelector(".map__filters-container"),n=(()=>{const e=t.cloneNode(!0);return e.querySelector(".popup__title").textContent="",e.querySelector(".popup__text--address").textContent="",e.querySelector(".popup__text--price").textContent="",e.querySelector(".popup__text--capacity").textContent="",e.querySelector(".popup__text--time").textContent="",e.querySelector(".popup__description").textContent="",e.classList.add("hidden"),o.before(e),e})(),r=n.querySelector(".popup__close"),i=n.querySelector(".popup__photo"),a=(e,t,o)=>{e?(t.classList.remove("hidden"),o()):t.classList.add("hidden")},s=e=>{window.util.isEscEvent(e,d)},c=()=>{d()},d=()=>{n.classList.add("hidden"),document.removeEventListener("keydown",s),r.removeEventListener("click",c),document.querySelector(".map__pin--active").classList.remove("map__pin--active")};window.adCard={render:t=>{const o=n.querySelector(".popup__title");a(t.offer.title,o,(()=>{o.textContent=t.offer.title}));const r=n.querySelector(".popup__text--address");a(t.offer.address,r,(()=>{r.textContent=t.offer.address}));const s=n.querySelector(".popup__text--price");a(t.offer.price,s,(()=>{s.innerHTML=`${t.offer.price}&#x20bd;<span>/ночь</span>`}));const c=n.querySelector(".popup__type");a(t.offer.type,c,(()=>{c.textContent=e[t.offer.type].name}));const d=n.querySelector(".popup__description");a(t.offer.description,d,(()=>{d.textContent=t.offer.description}));const l=n.querySelector(".popup__avatar");a(t.author.avatar,l,(()=>{l.src=t.author.avatar}));const u=n.querySelector(".popup__features");a(t.offer.features,u,((e,t)=>()=>{t.querySelectorAll(".popup__feature").forEach((e=>{e.classList.add("hidden")})),e.offer.features.forEach((e=>{n.querySelector(`.popup__feature--${e}`).classList.remove("hidden")}))})(t,u));const m=n.querySelector(".popup__photos");a(t.offer.photos,m,((e,t)=>()=>{window.util.clearElement(t);const o=document.createDocumentFragment();e.offer.photos.forEach((e=>{const t=i.cloneNode(!0);t.src=e,o.append(t)})),t.append(o)})(t,m)),(e=>{const t=n.querySelector(".popup__text--capacity"),o=e.offer.rooms?window.util.getNoun(e.offer.rooms,"Без комнат",`${e.offer.rooms} комната`,`${e.offer.rooms} комнаты`,`${e.offer.rooms} комнат`):"";let r;r=o?e.offer.guests?window.util.getNoun(e.offer.guests,", не для гостей",` для ${e.offer.guests} гостя`,` для ${e.offer.guests} гостей`,` для ${e.offer.guests} гостей`):"":e.offer.guests?window.util.getNoun(e.offer.guests,"Не для гостей",`Для ${e.offer.guests} гостя`,`Для ${e.offer.guests} гостей`,`Для ${e.offer.guests} гостей`):"",t.textContent=`${o}${r}`,t.textContent?t.classList.remove("hidden"):t.classList.add("hidden")})(t),(e=>{const t=n.querySelector(".popup__text--time");let o="";e.offer.checkout&&e.offer.checkin?o=`Заезд после ${e.offer.checkin}, выезд до ${e.offer.checkout}`:!e.offer.checkin&&e.offer.checkin?o=`Выезд до ${e.offer.checkout}`:e.offer.checkin&&!e.offer.checkin&&(o=`Заезд после ${e.offer.checkin}`),t.textContent=o,o?t.classList.add("hidden"):t.classList.remove("hidden")})(t)},open:e=>{n.classList.remove("hidden"),document.addEventListener("keydown",s),r.addEventListener("click",c),(e=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.classList.remove("map__pin--active")})),e.classList.add("map__pin--active")})(e)},close:d}})(),(()=>{const e={middle:{min:1e4,max:5e4},low:{min:0,max:1e4},high:{min:5e4,max:1/0}},t=document.querySelector(".map__filters"),o=t.querySelector("#housing-type"),n=t.querySelector("#housing-price"),r=t.querySelector("#housing-rooms"),i=t.querySelector("#housing-guests"),a=(t,o,n,r,i,a)=>{const s="any"===o||t.offer.type===o,c="any"===n||t.offer.price>=e[n].min&&t.offer.price<=e[n].max,d="any"===r||+t.offer.rooms==+r,l="any"===i||+t.offer.guests==+i;let u=!0;for(let e=0;e<a.length;e++)if(!t.offer.features.includes(a[e].value,0)){u=!1;break}return s&&c&&d&&l&&u},s=e=>window.util.debounce((()=>{window.ads.removePins();const s=t.querySelectorAll(".map__checkbox:checked");window.ads.renderPins(((e,t,o,n,r,i)=>{let s=e.slice(),c=[];for(let d=0;d<e.length&&(!a(e[d],t,o,n,r,i)||(c.push(s[d]),5!==c.length));d++);return c})(e,o.value,n.value,r.value,i.value,s))}),500);window.adsFilters={activate:e=>{t.addEventListener("change",s(e))},deactivate:e=>{t.removeEventListener("change",s(e))}}})(),(()=>{const e=document.querySelector(".map__pins"),t=document.querySelector(".map__filters"),o=document.querySelector(".map__card"),n=document.querySelector("#pin").content.querySelector(".map__pin"),r=e=>{const t=n.cloneNode(!0),o=t.querySelector("img");return t.style=`left: ${e.location.x-25}px; top: ${e.location.y-70}px;`,o.src=e.author.avatar,o.alt=e.offer.title,t.addEventListener("click",(o=>{o.preventDefault(),window.adCard.render(e),window.adCard.open(t)})),t},i=t=>{const o=document.createDocumentFragment(),n=t.length<=5?t.length:5;for(let e=0;e<n;e++)t[e].offer?o.append(r(t[e])):n=t.length<=n+1?t.length:n+1;e.append(o)};window.ads={load:e=>{i(e),window.adsFilters.activate(e)},errorLoad:o=>{const n=document.createElement("div"),r=document.createElement("span");r.textContent=`${o}. Не удалось загрузить похожие объявления`,n.style="position: absolute; top: 20px; left: 20px; padding: 14px; max-width: 400px; text-align: center; font-weight: 700; font-size: 18px; color: #ffffff; background-color: #ff5635; border-radius: 8px;",n.appendChild(r),e.appendChild(n),t.classList.add("hidden")},renderPins:i,removePins:()=>{o.classList.contains("hidden")||window.adCard.close(),window.util.clearElement(e,[".map__overlay",".map__pin--main"])}}})(),(()=>{const e=["gif","jpg","jpeg","png"],t={palace:{name:"Дворец",minPrice:1e4},flat:{name:"Квартира",minPrice:1e3},house:{name:"Дом",minPrice:5e3},bungalow:{name:"Бунгало",minPrice:0}},o=document.querySelector(".ad-form"),n=o.querySelector("#type"),r=o.querySelector("#title"),i=o.querySelector("#price"),a=o.querySelector("#timein"),s=o.querySelector("#timeout"),c=o.querySelector("#capacity"),d=o.querySelector("#room_number"),l=o.querySelector("#avatar"),u=o.querySelector(".ad-form-header__preview img"),m=o.querySelector("#images"),p=o.querySelector(".ad-form__photo");i.placeholder=t[n.value].minPrice,i.min=t[n.value].minPrice,c.querySelector(`[value="${d.value}"]`).setAttribute("selected","");const f=e=>{e.style.boxShadow=""!==e.validationMessage?"0 0 2px 2px #ff0000":"none"},v=()=>{const e=r.value.length;0===e?r.setCustomValidity("Обязательное поле"):e>100?r.setCustomValidity(`Удалите лишние ${e-100} симв.`):e<30?r.setCustomValidity(`Минимальное количество символов 30. Введите еще ${30-e} симв.`):r.setCustomValidity(""),r.reportValidity(),f(r)},w=()=>{f(r)},y=()=>{const e=i.value;0===e?i.setCustomValidity("Обязательное поле"):e>1e6?i.setCustomValidity("Стоимость не может превышать 1000000"):e<i.min?i.setCustomValidity(`${t[n.value].name} не может стоить меньше ${i.min}`):i.setCustomValidity(""),i.reportValidity(),f(i)},h=()=>{f(i)},g=()=>{i.placeholder=t[n.value].minPrice,i.min=t[n.value].minPrice},_=()=>{s.value=a.value},L=()=>{a.value=s.value},S=()=>{const e=d.value,t=c.value;e<100&&0!=+t&&t>e?c.setCustomValidity("На одного человека должно приходиться не меньше одной комнаты"):e<100&&0==+t?c.setCustomValidity("А как же гости? Впустите хотя бы одного"):100==+e&&0!=+t?c.setCustomValidity("В таких хоромах гостям не место"):c.setCustomValidity(""),c.reportValidity(),f(c)},E=S,q=()=>{const t=l.files[0],o=t.name.toLowerCase();if(e.some((e=>o.endsWith(e)))){const e=URL.createObjectURL(t);u.src=e}},x=()=>{const t=m.files[0],o=t.name.toLowerCase();if(e.some((e=>o.endsWith(e)))){const e=URL.createObjectURL(t);p.style.backgroundImage=`url(${e})`,p.style.backgroundSize="cover"}};window.adFormValidity={activate:()=>{r.addEventListener("input",v),r.addEventListener("invalid",w),i.addEventListener("invalid",h),i.addEventListener("input",y),n.addEventListener("change",g),a.addEventListener("change",_),s.addEventListener("change",L),c.addEventListener("change",S),d.addEventListener("change",E),l.addEventListener("change",q),m.addEventListener("change",x)},deactivate:()=>{r.removeEventListener("input",v),r.removeEventListener("invalid",w),i.removeEventListener("invalid",h),i.removeEventListener("input",y),n.removeEventListener("change",g),a.removeEventListener("change",_),s.removeEventListener("change",L),c.removeEventListener("change",S),d.removeEventListener("change",E),l.removeEventListener("change",q),m.removeEventListener("change",x)}}})(),(()=>{const e=document.querySelector(".map"),t=document.querySelector(".ad-form"),o=document.querySelector(".map__filters"),n=e.querySelector(".map__pin--main"),r=e=>{0===e.button&&s(e)},i=e=>{window.util.isEnterEvent(e,s)},a=()=>{e.classList.add("map--faded"),window.util.toggleFormDisability(t,!0),t.reset(),t.classList.add("ad-form--disabled"),window.adFormValidity.deactivate(),window.util.toggleFormDisability(o,!0),o.reset(),window.adsFilters.deactivate(),n.style.left="570px",n.style.top="375px",window.pin.changeAddress(570,375),n.removeEventListener("mousedown",window.pin.onMainPinMouseDown),n.removeEventListener("keydown",window.pin.onMainPinKeydown),n.addEventListener("mousedown",r),n.addEventListener("keydown",i)},s=a=>{window.load("https://21.javascript.pages.academy/keksobooking/data","GET",window.ads.load,window.ads.errorLoad,1e4),e.classList.remove("map--faded"),window.util.toggleFormDisability(t,!1),t.classList.remove("ad-form--disabled"),window.adFormValidity.activate(),window.util.toggleFormDisability(o,!1),"mousedown"===a.type&&window.pin.onMainPinMouseDown(a),n.addEventListener("mousedown",window.pin.onMainPinMouseDown),n.addEventListener("keydown",window.pin.onMainPinKeydown),n.removeEventListener("mousedown",r),n.removeEventListener("keydown",i)};a(),window.activeMode={turnOff:a}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success"),o=document.querySelector("#error").content.querySelector(".error");let n;const r=()=>{n.remove(),document.removeEventListener("keydown",i),document.removeEventListener("click",a)},i=e=>{window.util.isEscEvent(e,r)},a=e=>{e.preventDefault(),r()},s=()=>{r()};window.adFormStatusMessage={open:r=>{"success"===r?n=t.cloneNode(!0):"error"===r&&(n=o.cloneNode(!0),n.querySelector(".error__button").addEventListener("click",s)),document.addEventListener("keydown",i),document.addEventListener("click",a),e.appendChild(n)}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector(".ad-form__reset"),o=e.querySelectorAll("input"),n=e.querySelectorAll("select"),r=e.querySelector(".ad-form-header__preview img"),i=e.querySelector(".ad-form__photo"),a=()=>{r.src="img/muffin-grey.svg",i.style.backgroundImage="none"},s=()=>{window.adFormStatusMessage.open("success"),window.activeMode.turnOff(),window.ads.removePins(),a()},c=()=>{window.adFormStatusMessage.open("error")};e.addEventListener("submit",(t=>{t.preventDefault(),window.load("https://21.javascript.pages.academy/keksobooking","POST",s,c,1e4,new FormData(e))})),t.addEventListener("click",(e=>{e.preventDefault(),window.activeMode.turnOff(),window.ads.removePins(),o.forEach((e=>{e.style.boxShadow="none"})),n.forEach((e=>{e.style.boxShadow="none"})),a()}))})()})();